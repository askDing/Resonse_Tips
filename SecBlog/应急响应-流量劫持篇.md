应急响应-流量劫持篇

[toc]





## 常用工具介绍
- [SysinternalSuite]
- [PCHunter]/[火绒剑]/[PowerTool]
- [Process Monitor]
- [Event Log Explorer]
- [FullEventLogView]
- [Log Parser]
- [WinPrefetch View]
- [WifiHistory View]

[SysinternalSuite]: https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite
[PCHunter]: https://www.bleepingcomputer.com/download/pc-hunter/
[火绒剑]: http://bbs.huorong.cn/forum.php?mod=forumdisplay&fid=55&filter=typeid&typeid=44
[PowerTool]: http://powertool.s601.xrea.com/
[Process Monitor]: https://docs.microsoft.com/zh-cn/sysinternals/downloads/procmon
[Event Log Explorer]: https://www.filehorse.com/download-event-log-explorer/
[FullEventLogView]: https://www.snapfiles.com/get/fulleventlogview.html
[Log Parser]: https://www.microsoft.com/en-us/download/details.aspx?id=24659


## 系统排查
### 系统基本信息
#### Windows
在搜索框中键入`msinfo32` 。
用鼠标右键单击搜索结果中的`系统信息`，然后选择`以管理员身份运行`。
![a93f5098a4414a0a9363510bd1e6536e](../images/a93f5098a4414a0a9363510bd1e6536e.png)

#### Linux
```zsh
lscpu  # 查看CPU相关信息，包括型号、主频、内核等信息
uname -a   # 查看当前操作系统信息
cat /proc/version #查看当前操作系统版本
lsmod  # 查看所有已载入系统的模块信息
```


### 系统用户信息

#### Windows  

1. 命令行查看
	> &rem 为cmd下的注释符
	```zsh
	net user   &rem 收集用户账户信息，但看不到以$结尾的隐藏账户
	net user <username>  &rem 查看指定用户的详细信息
	```
	
2. GUI查看
	在cmd中输入`compmgmt.msc`即可调出*计算机管理*窗口
	
	![d0ebb9ab52e44ae3b969a9efd5fa2ddd](../images/d0ebb9ab52e44ae3b969a9efd5fa2ddd-7216687.png)
	
3. 注册表查看
    配置当用用户拥有对SAM的读取权限,配置后按F5刷新
    ![503552b6001c4dbd902ce0d4cbe6d8ed](../images/503552b6001c4dbd902ce0d4cbe6d8ed.png)

  > 在第3步选中账户给予：**完全控制** 亦可。

  ![941991812b1c4a54b1ee30fc2a760532](../images/941991812b1c4a54b1ee30fc2a760532.png)

4. wmic查看
  >wmic是WMI(Widnwos Management Instrumentation)的扩展，
  >提供从命令行接口和批命令脚本执行系统管理命令
  ```zsh
  wmic useraccount get name,sid  &rem 获取系统中用户名和系统的SID值
  ```


#### Linux
```zsh
cat /etc/passwd   # 查看系统所有用户信息
awk -F: '{if($3==0)print $1}' /etc/passwd   # 查看用户UID为0的账户，即root账户
awk -F:'length($2)==0{print $1}' /etc/shadow # 查看是否存在空口令账户
cat /etc/passwd | grep '/bin/bash'  # 查看可登陆的用户
last  # 查看显示近期用户或终端的登录情况
lastlog  # 查看登陆过所有用户的最近一次登陆时间
lastb  # 查看登陆失败的用户账户信息
who   # 查看当前登陆系统的用户
```
`last -f` 指定数据源,如下:
- /var/log/wtmp 存储登陆成功信息
- /var/log/btmp 存储登陆失败信息
- /var/log/utmp 存储当前正在登陆的信息


### 启动项
#### Windows
	1. 通过【系统配置】对话框查看
![9880129cd6d843259656ac63576ac45b](../images/9880129cd6d843259656ac63576ac45b.png)

	2. 通过注册表查看
> 路径：计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

![ca0812f9432145e3a6e5a5e2db4cc6da](../images/ca0812f9432145e3a6e5a5e2db4cc6da.png)

#### Linux
```zsh
more /etc/init.d/rc.local /etc/rc.d/rc[0-6].d  # 查看rc.local文件内容
ls -alt /etc/init.d/   # 查看init.d文件夹下所有文件的详细信息

```

### 任务计划
#### Windows
> 通过计算机管理窗口查询  
> 		通过powershell查询  
> 		通过cmd查询
>
> ![a7b31da5c57a405baccce9493a73dffe](../images/a7b31da5c57a405baccce9493a73dffe.png)

#### Linux
```zsh
crontab -u root  -l  # 查看root用户的计划任务
more /etc/cron*/   # 查看cron下的定时任务
cat /etc/anacrontab   # 查看anacrontab中的任务
```


### 其他
1. Windows防火墙规则
```zsh
netsh firewall show state
```
![e7a3acc5ed63472eaf873a92e5dc29ec](../images/e7a3acc5ed63472eaf873a92e5dc29ec.png)


## 进程排查
#### Windows
##### 通过【任务管理器查看】查看
> 添加【命令行】、【映射路径名称】列，获取更多信息

![46b967b2cc814f4da8a9d28ce5ffae0f](../images/46b967b2cc814f4da8a9d28ce5ffae0f.png)


##### 通过`tasklist`查看
```zsh
tasklist  &rem 查看所有进程的映像名称、服务、PID、会话名等信息
tasklist /svc  &rem 查看进程映像名，PID，服务
tasklist /m    &rem 查看所有进程加载的DLL文件
tasklist /m  ntdll.dll  &rem 查看调用指定ntdll.dll文件的进程
```
##### 使用`netstat`查看
```zsh
netstat -anb | findstr "ESTABLISHED"  &rem 查看端口连接情况及端口对应的程序，需要管理员权限
netstat -ano | findstr "ESTABLISHED"  &rem 查看目前已建立的网络连接，可定位PID
tasklist | findstr <PID>  &rem 定位具体的程序
```
##### 使用【PowerShell】查看
```zsh
Get-WmiObject Win32_Process | select Name,ProcessId,ParentProcessId,Path   # 获取进程名，进程ID，PID，路径
```

##### 使用【WMIC】查看
>cmd下注释符 &rem     PowerShell下注释符 #
```zsh
wmic process get name,parentprocessid,processid,executablepath， commandline /format:csv  &rem 获取进程名，PID，ID,执行路径,命令行
wmic process where processid=<PID> get name, executablepath &rem 获取指定PID的进程名和执行路径
wmic process where name="malware.exe" call terminate &rem 删除“malware.exe“恶意程序的进程
wmic process where processid=<PID> delete  &rem 删除<PID>的进程
```

#### Linux
```zsh
netstat -antlp | more  # 查看进程、端口连接情况，可定位PID
ls -alt /proc/<PID>/exe  # 可查看PID对应可执行程序
lsof -p <PID>   # 查看PID对应的进程打开的文件

#查看隐藏进程
ps -ef | awk '{print}' | sort -n | uniq >1
ls /proc | sort -n | uniq >2
diff 1 2
```

## 服务排查
### Windows
![75855228859847989d6a3102ee182e22](../images/75855228859847989d6a3102ee182e22.png)

### Linux
```zsh
chkconfig --list  # 查看系统运行的服务
service --status-all ｜ more  # 查看所有服务的状态
```
## 文件痕迹排查
### Windows
#### 敏感目录

1. 各个盘下的Temp目录
	
> C:\Windows\Temp\

2. 浏览器历史记录，下载记录
3. 用户Recent文件
	> C:\Documents and Settings\Administrator\Recent  
	> C:\Documents and Settings\Default User\Recent  
4. 预读取文件夹Prefetch
	> C:\Windows\Prefetch   
	> %SystemRoot%\appcompat\Programs\  查询Amcache.hve文件所在目录，可以查询用用程序的执行路径，上次执行的时间及SHA1值
	

![0fa23f2bffff4a80a77dbb87ff55c1a7](../images/0fa23f2bffff4a80a77dbb87ff55c1a7.png)

#### 时间点查找
```zsh
forfiles  /m *.exe   /d +2020/12/05  /s  /p C:\  /c "cmd /c echo @path @fdate @ftime " 2> null  &rem 针对2020-12-5日后的exe新建文件进行搜索
```

#### Webshell
可利用D盾、HwsKill、WebshellKill等工具对目录下的文件进行规则查询


### Linux
#### 敏感目录
- /usr/bin 和/usr/sbin
- .ssh/ 和/etc/ssh
- /tmp

#### 时间点查找
```zsh
find / -ctime 0 -name "*.sh"  # 查找一天内新增的sh文件
ls -alt | head -n 10  # 列出最近修改的10个文件
stat <xx.sh>   # 对xx.sh的创建、修改、访问时间进行排查
```

#### 特殊文件
1. 常规检查
```zsh
find / -type f -perm -04000 -ls -uid 0 2>/dev/null   # 排查SUID程序
find /tmp -perm 777 | more  # 查找777权限的文件
find /var/www/ -name "*.php" |xargs egrep 'assert|phpspy|c99sh|milw0rm|eval|\(gunerpress|\(base64_decoolcode|spider_bc|shell_exec|passthru|\(\$\_\POST\[|eval
\(str_rot13|\.chr\(|\$\{\"\_P|eval\(\$\_R|file_put_contents\(\.\*\$\_|base64_decode'   # 查找/var/www目录下的webshell
ls -alt /bin  # 对系统命令进行排查，查看命令目录中相关系统命令的修改时间
ls -alh /bin  # 对系统命令进行排查，查看命令目录中相关系统命令的文件大小
```
2. 后门查杀
	- [chkrootkit] 检测rootkit是否被安装到系统中
	```zsh
	chkroot -q | grep INFECTED
	```
	- [rkhunter] 检测系统命令，包括MD5校验，本机敏感目录，系统配置，服务及套件，第三方应用版本等。
	```zsh
	rkhunter --check
	```
[chkrootkit]: https://github.com/Magentron/chkrootkit.git
[rkhunter]: https://github.com/installation/rkhunter.git


## 日志分析


## 内存分析


## 流量分析-Wireshark简单使用


## 威胁情报